<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheet Data Fetch</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- jsPDF and autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="row text-center mb-4 g-3">
            <div class="col-md-4 col-6"></div>
            <div class="col-md-4 col-6">
                <div class="card shadow-sm bg-success text-white h-100 d-flex flex-column" style="cursor: pointer;">
                    <div class="card-body flex-grow-1 d-flex flex-column justify-content-center">
                        <h5 class="card-title text-uppercase">Total Entries</h5>
                    </div>
                    <button class="btn btn-light text-dark fs-3 fw-bold w-100 rounded-0 border-0">
                        <span id="totalEntries"></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container p-3">
            <div class="table-responsive">
                <table id="myTable" class="table table-hover table-bordered">
                    <thead class="table-dark"></thead>
                    <tbody>
                        <h1 id="process" style="color: red; text-align: center;">Loading...</h1>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            const csvURL = "https://docs.google.com/spreadsheets/d/10gZKdHfL2DZRSpNA5-bpg7IcfX3zwXX2afEjh_oEaus/export?format=csv";

            $("#process").show();

            Papa.parse(csvURL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    $("#process").hide();

                    const filteredData = results.data.map((row) => ({
                        full_name: row["name"] ? row["name"].trim() : "",
                        order_id: row["order_id"] ? row["order_id"].trim() : "",
                        product_name: row["product name"] ? row["product name"].trim() : "",
                        price: row["price"] ? row["price"].trim() : "",
                    }));

                    $("#totalEntries").text(filteredData.length);

                    $("#myTable").DataTable({
                        destroy: true,
                        data: filteredData.map((row) => [
                            row.full_name,
                            row.order_id,
                            row.product_name,
                            row.price,
                            `<button class="btn btn-primary btn-sm w-100" onclick="generatePDF('${row.full_name}', '${row.order_id}', '${row.product_name}', '${row.price}')">Download Invoice</button>`,
                        ]),
                        columns: [
                            { title: "Full Name" },
                            { title: "Order ID" },
                            { title: "Product Name" },
                            { title: "Price" },
                            { title: "Action" },
                        ],
                    });
                },
            });
        });

        function generatePDF(name, orderID, product, price) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text("Invoice", 90, 20);

            doc.setFontSize(12);
            doc.text(`Customer Name: ${name}`, 20, 40);
            doc.text(`Order ID: ${orderID}`, 20, 50);
            doc.text(`Product Name: ${product}`, 20, 60);
            doc.text(`Price: ₹${price}`, 20, 70);

            doc.autoTable({
                startY: 85,
                head: [["Item", "Price"]],
                body: [[product, `₹${price}`]],
                theme: "striped",
                styles: { fontSize: 10 },
            });

            doc.text("Thank you for your purchase!", 20, doc.autoTable.previous.finalY + 15);
            doc.save(`Invoice_${orderID}.pdf`);
        }
    </script>
</body>
</html>
